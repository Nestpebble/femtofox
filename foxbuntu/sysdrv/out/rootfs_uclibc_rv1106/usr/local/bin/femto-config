#!/bin/bash
# prevents weirdness over tty
export NCURSES_NO_UTF8_ACS=1
export TERM=screen
export LANG=C.UTF-8

if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root."
  echo "Try \`sudo femto-config\`."
  exit 1
fi

# pause
pause() {
  echo "Press any key to continue..."
  read -n 1 -s -r
}



#│ ^[[0;30m Black^[[0m ^[[0;31m Red^[[0m ^[[0;32m       │
#│ Green^[[0m ^[[0;33m Yellow^[[0m ^[[0;34m Blue^[[0m   │
#│ ^[[0;35m Magenta^[[0m ^[[0;36m Cyan^[[0m ^[[0;37m    │
#│ White^[[0m ^[[4m Underlined^[[0m ^[[7m Inverted^[[0m


replace_colors() {
  input="$1"
  input="${input//$(echo -e '\033[0;30m')/\\Z0}"   # black
  input="${input//$(echo -e '\033[0;31m')/\\Z1}"   # red
  input="${input//$(echo -e '\033[0;32m')/\\Z2}"   # green
  input="${input//$(echo -e '\033[0;33m')/\\Z3}"   # yellow
  input="${input//$(echo -e '\033[0;34m')/\\Z4}"   # blue
  input="${input//$(echo -e '\033[0;35m')/\\Z5}"   # magenta
  input="${input//$(echo -e '\033[0;36m')/\\Z6}"   # cyan
  input="${input//$(echo -e '\033[0;37m')/\\Z7}"   # white
  input="${input//$(echo -e '\033[7m')/\\Zr}"      # invert
  input="${input//$(echo -e '\033[4m')/\\Zu}"      # underline
  input="${input//$(echo -e '\033[0m')/\\Zn}"      # reset
  echo "$input"
}

wifi_config() {
  local wifi_ssid=""
  local wifi_psk=""
  local wifi_country=""
  wifi_ssid=$(dialog --title "$title2" --inputbox "Enter Wi-Fi SSID:" 8 40 "$(grep -oP '^ *ssid="\K[^"]+' /etc/wpa_supplicant/wpa_supplicant.conf)" 3>&1 1>&2 2>&3) # display current SSID
  wifi_psk=$(dialog --title "$title2" --inputbox "Enter Wi-Fi Password:" 8 40 3>&1 1>&2 2>&3)
  wifi_country=$(dialog --title "$title2" --inputbox "Enter Country Code (US, DE...):" 9 40 "$(grep -oP '^ *country=\K[^ ]+' /etc/wpa_supplicant/wpa_supplicant.conf)" 3>&1 1>&2 2>&3) # display current country
  cmd="femto-network-config.sh -s \"$wifi_ssid\" -p \"$wifi_psk\""
  [ -n "$wifi_country" ] && cmd="$cmd -c \"$wifi_country\""
  cmd="$cmd -r"
  if [ -z "$wifi_ssid" ]; then
    dialog --title "$title2" --msgbox "\nSSID is required to configure Wi-Fi." 8 40
    return
  fi
  eval $cmd
  dialog --title "$title2" --msgbox "Wi-Fi Settings Saved:\nSSID: $wifi_ssid\nPassword: (hidden)\nCountry: $wifi_country\nMeshtastic Wi-Fi setting set to ON" 9 40
  if [ "$1" = "-w" ]; then
    exit 0
  fi
}

# Function to handle Wi-Fi settings
networking_settings() {
  local title="Networking"
  local title2="Wi-Fi (wlan0) Settings"
  wpa_supplicant_conf="/etc/wpa_supplicant/wpa_supplicant.conf"
  while true; do
    local option=""
    option=$(dialog --cancel-label "Back" --menu "$title" 16 40 4 \
      1 "Turn Wi-Fi on/off" \
      2 "View Wi-Fi settings" \
      3 "Change Wi-Fi settings" \
      4 "View ethernet settings" \
      5 "Restart networking" \
      6 "Set hostname" \
      7 "Test internet connection" \
      "" "" \
    8 "Back to Main Menu" 3>&1 1>&2 2>&3)
    
    exit_status=$? # This line checks the exit status of the dialog command
    if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
      break
    fi
    
    case $option in
      1) # Turn Wi-Fi on/off)
        if ! ip link show wlan0 &>/dev/null; then
          dialog --colors --msgbox "\Z1Network adapter wlan0 does not exist.\Zn\n\nIs a wifi adapter connected?" 8 40
        else
          while true; do
            choice=$(dialog --cancel-label "Back" --title "Wi-Fi Status" --menu "Enable/disable Wi-Fi" 9 40 5 \
              1 "Turn Wi-Fi on" \
              2 "Turn Wi-Fi off" 3>&1 1>&2 2>&3)
            exit_status=$? # This line checks the exit status of the dialog command
            if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
              break
            fi
            case $choice in
              1) femto-network-config.sh -x "up" && break ;;
              2) femto-network-config.sh -x "down" && break ;;
            esac
          done
        fi
      ;;
      2) # View Wi-Fi settings)
        echo "Getting Wi-Fi configuration..."
        dialog --title "$title2" --colors --msgbox "$(replace_colors "$(femto-network-config.sh -w)")" 0 0
      ;;
      3) # Change Wi-Fi settings)
        wifi_config
      ;;
      4) # View ethernet settings)
        echo "Getting ethernet configuration..."
        dialog --title "Ethernet (eth0) settings" --colors --msgbox "$(replace_colors "$(femto-network-config.sh -e)")" 0 0
      ;;
      5) # Restart networking)
        dialog --title "$title2" --yesno "Wi-Fi and Ethernet will be restarted.\nMeshtastic Wi-Fi setting will be set to ON.\n\nProceed?" 10 40
        if [ $? -eq 0 ]; then #unless cancel/no
          femto-network-config.sh -r
        fi
      ;;
      6) # set hostname)
        new_hostname=$(dialog --title "$title" --inputbox "Enter new hostname:" 8 40 $(hostname) 3>&1 1>&2 2>&3)
        if [ $? -eq 0 ]; then #unless cancel/no
          femto-network-config.sh -n "$new_hostname"
          dialog --title "$title" --msgbox "Femtofox is now reachable at\n$new_hostname.local" 8 40
        fi
      ;;
      7) # Test internet connection)
        dialog --infobox "Testing internet connection..." 0 0
        dialog --title "Internet connectivity test" --colors --msgbox "$(replace_colors "$(femto-network-config.sh -t)")" 8 40
      ;;
      8)
        return
      ;;
    esac
  done
}

  # Pinout menu
femto_pinouts() {
  while true; do
    local option=""
    option=$(dialog --cancel-label "Back" --menu "Pinouts" 15 40 5 \
      1 "Femtofox" \
      2 "Femtofox Zero" \
      3 "Femtofox Tiny" \
      4 "Luckfox Pico Mini" \
      "" "" \
      5 "Back to Help Menu" 3>&1 1>&2 2>&3)
    
    exit_status=$? # This line checks the exit status of the dialog command
    
    if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
      break
    fi
    
    case $option in
      1) dialog --title "Femtofox" --msgbox "$(femto-pinout.sh -f)" 41 70 ;;
      2) dialog --title "Femtofox Zero" --msgbox "$(femto-pinout.sh -z)" 34 48 ;;
      3) dialog --title "Femtofox Tiny" --msgbox "$(femto-pinout.sh -t)" 38 70 ;;
      4) dialog --title "Luckfox Pico Mini" --msgbox "$(femto-pinout.sh -l)" 23 65 ;;
      5) return ;;
    esac
  done
}

# Function to handle misc settings
misc_settings() {
  local title="Misc Settings"
  while true; do
    local option=""
    option=$(dialog --cancel-label "Back" --menu "Misc Settings" 15 40 4 \
      1 "Set system timezone" \
      2 "Ham radio support" \
      3 "Re-run first-boot script" \
      4 "Run OEM luckfox-config" \
      "" "" \
      5 "Back to Main Menu" 3>&1 1>&2 2>&3)
    
    exit_status=$? # This line checks the exit status of the dialog command
    if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
      break
    fi
    
    case $option in
      1) # set timezone)
        femto-set-timezone.sh
      ;;
      2) # the contents of this should probably moved to a script)
        dialog --title "$title" --msgbox "Amateur radio support can be added in kernel for:\n\n\
Amateur Radio AX.25 Level 2 protocol\n\
AX.25 DAMA Slave support\n\
Amateur Radio NET/ROM protocol\n\
Amateur Radio X.25 PLP (Rose)\n\
Serial port KISS driver\n\
Serial port 6PACK driver\n\
BPQ Ethernet driver\n\
BAYCOM ser12 fullduplex driver for AX.25\n\
BAYCOM ser12 halfduplex driver for AX.25\n\
YAM driver for AX.25\n\
AM/FM Radio receivers/transmitters\n\
Software defined radio (SDR)\n\
Maxim 2175 RF to Bits tuner\n\
Silicon Labs Si470x FM Radio Receiver support\n\
Silicon Labs Si470x FM Radio Receiver support with USB\n\
Silicon Labs Si470x FM Radio Receiver support with I2C\n\
Silicon Labs Si4713 FM Radio with RDS Transmitter support\n\
Silicon Labs Si4713 FM Radio Transmitter support with USB\n\
Silicon Labs Si4713 FM Radio Transmitter support with I2C\n\
Silicon Labs Si4713 FM Radio Transmitter support\n\
AverMedia MR 800 USB FM radio support\n\
D-Link/GemTek USB FM radio support\n\
Guillemot MAXI Radio FM 2000 radio\n\
Griffin radioSHARK USB radio receiver\n\
Griffin radioSHARK2 USB radio receiver\n\
Keene FM Transmitter USB support\n\
Thanko's Raremono AM/FM/SW radio support\n\
Masterkit MA901 USB FM radio support\n\
TEA5764 I2C FM radio support\n\
SAA7706H Car Radio DSP\n\
TEF6862 Car Radio Enhanced Selectivity Tuner\n\
Texas Instruments WL1273 I2C FM Radio\n\
Renesas Digital Radio Interface (DRIF)" 20 65
        dialog --title "$title" --msgbox "To add support, kernel modules for all these will be copied to \`/lib/modules/5.10.160/\`,\
then \`depmod\` will be run. To remove support, those modules will be deleted.\n\nAfter installation, many redundant network interfaces will appear." 11 40
        #add code to choose add or remove
        cp /oem/usr/ko/ham/* /lib/modules/5.10.160/
        depmod -a 5.10.160
      ;;
      3)
        femto-runonce.sh
      ;;
      4)
        luckfox-config
      ;;
      5)
        return
      ;;
    esac
  done
}

#set lora radio
set_lora_radio() {
  while true; do
    local option=""
    option=$(dialog --menu "Select your installed Meshtastic LoRa radio." 0 0 10 \
      1 "ebyte-e22-900m30s (Femtofox Pro)" \
      2 "ebyte-e22-900m22s" \
      3 "ebyte-e80-900m22s" \
      4 "heltec-ht-ra62" \
      5 "seeed-wio-sx1262" \
      6 "waveshare-sx126x-xxxm" \
      7 "ai-thinker-ra-01sh" \
      8 "sx1262_tcxo" \
      9 "sx1262_xtal" \
      10 "lr1121_tcxo" \
      11 "none (simulated radio)" \
      "" "" \
    12 "Skip" 3>&1 1>&2 2>&3)
    
    exit_status=$? # This line checks the exit status of the dialog command
    if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
      break
    fi
    
    local radio=""
    case $option in
      1)
        radio="sx1262_tcxo"
      ;;
      2)
        radio="sx1262_tcxo"
      ;;
      3)
        radio="sx1262_xtal"
      ;;
      4)
        radio="sx1262_tcxo"
      ;;
      5)
        radio="sx1262_tcxo"
      ;;
      6)
        radio="sx1262_xtal"
      ;;
      7)
        radio="sx1262_xtal"
      ;;
      8)
        radio="sx1262_tcxo"
      ;;
      9)
        radio="sx1262_xtal"
      ;;
      10)
        radio="lr1121_tcxo"
      ;;
      11)
        radio="none"
      ;;
      12)
        return
      ;;
    esac
    if [ -n "$radio" ]; then #if a radio was selected
      femto-meshtasticd-config.sh -l "$radio" -s # set the radio, then restart meshtasticd
      return
    fi
  done
}

# Function to handle Meshtasticd settings
meshtasticd_settings() {
  local title="Meshtastic Settings"
  while true; do
    if echo "$(systemctl status meshtasticd)" | grep -q "active (running)"; then
      local service_state="\Z2\Zuonline\Zn"
    elif echo "$(systemctl status meshtasticd)" | grep -q "inactive (dead)"; then
      local service_state="\Z1\Zuoffline\Zn"
    else
      local service_state="unknown"
    fi
    local option=""
    option=$(dialog --colors --title "$title" --cancel-label "Back" --menu "Meshtasticd service is $service_state" 23 50 4 \
      1 "View configuration URL & QR code" \
      2 "Set new configuration URL" \
      3 "View lora radio selection" \
      4 "Set LoRa radio" \
      5 "View admin keys" \
      6 "Set admin key" \
      7 "Clear admin keys" \
      8 "Legacy admin channel" \
      9 "Detailed Meshtasticd service status" \
      10 "Start/restart Meshtasticd service" \
      11 "Stop Meshtasticd service" \
      12 "Upgrade/install Meshtasticd" \
      13 "Uninstall Meshtasticd" \
      "" "" \
    14 "Back to Main Menu" 3>&1 1>&2 2>&3)
    
    exit_status=$? # This line checks the exit status of the dialog command
    if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
      break
    fi
    
    case $option in
      1) #Get current configuration URL & QR code)
        dialog --infobox "Getting Meshtastic QR code and URL..." 5 45
        femto-meshtasticd-config.sh -g
        pause
      ;;
      2)
        newurl=$(dialog --title "Meshtastic URL" --inputbox "New Meshtasticd URL (SHIFT+INS to paste):" 8 60 3>&1 1>&2 2>&3)
        if [ -n "$newurl" ]; then #if a URL was entered
          dialog --title "$title" --yesno "New Meshtasticd URL:\n$newurl\n\nConfirm?" 15 60
          if [ $? -eq 0 ]; then #unless cancel/no
            femto-meshtasticd-config.sh -q "$newurl"
            pause
          fi
        fi
      ;;
      3)
        dialog --title "LoRa radio" --msgbox "Currently configured LoRa radio: $(femto-meshtasticd-config.sh -k)" 6 40
      ;;
      4)
        set_lora_radio
      ;;
      5)
        dialog --infobox "Getting admin keys..." 0 0
        dialog --title "Admin keys" --msgbox "Up to 3 admin keys are permitted, more will be ignored.\n\nKeys:$(femto-meshtasticd-config.sh -v | tail -n 1 | sed 's/|n/\\n/g')" 0 0
      ;;
      6) #set admin key)
        key=$(dialog --title "Meshtastic Admin Key" --inputbox "Meshtastic admin key - up to 3, more will be ignored.\n\n(SHIFT+INS to paste):" 11 40 3>&1 1>&2 2>&3)
        if [ -n "$key" ]; then #if a URL was entered
          femto-meshtasticd-config.sh -a "$key"
          pause
        fi
      ;;
      7)
        dialog --title "$title" --yesno "Meshtasticd can have up to 3 admin keys.\nClear admin key list?" 0 0
        if [ $? -eq 0 ]; then #unless cancel/no
          femto-meshtasticd-config.sh -c
          pause
        fi
      ;;
      8) #legacy admin)
        dialog --infobox "Getting current legacy admin state..." 5 45
        state=$(sudo femto-meshtasticd-config.sh -p)
        if echo "$state" | grep -q "True"; then
          state="Enabled"
        elif echo "$state" | grep -q "False"; then
          state="Disabled"
        elif echo "$state" | grep -q "Error"; then
          state="Error"
        fi
        while true; do
          choice=$(dialog --title "Meshtasticd Legacy Admin" --menu "Current state: $state" 10 40 5 \
            1 "Enable" \
            2 "Disable" 3>&1 1>&2 2>&3)
          exit_status=$? # This line checks the exit status of the dialog command
          if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
            break
          fi
          case $choice in
            1) femto-meshtasticd-config.sh -o "true" && break ;;
            2) femto-meshtasticd-config.sh -o "false" && break ;;
          esac
        done
      ;;
      9) #check meshtasticd service status)
        dialog --infobox "Getting Meshtasticd service status..." 5 45
        dialog --title "Meshtasticd service status" --msgbox "$(systemctl status meshtasticd)" 0 0
      ;;
      10) #start/restart meshtasticd)
        dialog --title "$title" --yesno "Start/restart Meshtasticd service?" 5 45
        if [ $? -eq 0 ]; then #unless cancel/no
          femto-meshtasticd-config.sh -s
          dialog --msgbox "Meshtasticd service started/restarted." 5 45
        fi
      ;;
      11) #stop meshtasticd)
        dialog --title "$title" --yesno "Stop Meshtasticd service?" 5 45
        if [ $? -eq 0 ]; then #unless cancel/no
          femto-meshtasticd-config.sh -t
          dialog --msgbox "Meshtasticd service stopped." 5 45
        fi
      ;;
      12) #Upgrade meshtasticd)
        dialog --title "$title" --yesno "Upgrade Meshtasticd?\nRequires internet connection." 0 0
        if [ $? -eq 0 ]; then #unless cancel/no
          femto-meshtasticd-config.sh -u
          pause
        fi
      ;;
      13) #uninstall meshtasticd)
        dialog --title "$title" --yesno "Uninstall Meshtasticd?\n\nFoxbuntu was designed with Meshtasticd integration in mind, and may behave unexpectedly if Meshtasticd is removed." 0 0
        if [ $? -eq 0 ]; then
          femto-meshtasticd-config.sh -x
          dialog --msgbox "Meshtasticd uninstalled. To purge all remnants, run \`sudo apt purge\`.\nAfter reinstallation but before first launch, run the \"first boot script\" from the misc menu." 8 40
        fi
      ;;
      14)
        return
      ;;
    esac
  done
}

#Help menu
help_menu() {
  while true; do
  local title="Help / About"
    local option=""
    option=$(dialog --cancel-label "Back" --menu "$title" 0 0 7 \
      1 "About Femtofox" \
      2 "Display pinout" \
      3 "Femtofox licensing info - short" \
      4 "Femtofox licensing info - long" \
      5 "Meshtastic licensing info" \
      6 "About Luckfox" \
      7 "About Ubuntu" \
      "" "" \
    8 "Back to Main Menu" 3>&1 1>&2 2>&3)
    
    exit_status=$? # This line checks the exit status of the dialog command
    if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
      break
    fi
    
    case $option in
      1) #About Femtofox)
        dialog --title "About Femtofox" --backtitle "Foxbuntu $(grep -oP 'major=\K[0-9]+' /etc/foxbuntu-release).$(grep -oP 'minor=\K[0-9]+' /etc/foxbuntu-release).$(grep -oP 'patch=\K[0-9]+' /etc/foxbuntu-release)$(grep -oP 'hotfix=\K[a-z]+' /etc/foxbuntu-release)" --msgbox "$(femto-license.sh -a)" 18 65
      ;;
      2) #Display pinout)
        femto_pinouts
      ;;
      3) #Femtofox licensing info - short)
        dialog --title "Femtofox license" --msgbox "$(femto-license.sh -f)" 28 60
      ;;
      4) #Femtofox licensing info - long)
        clear
        femto-license.sh -F
        pause
      ;;
      5) #Meshtastic licensing info)
        dialog --title "Meshtastic license" --msgbox "$(femto-license.sh -m)" 0 0
      ;;
      6) #About Luckfox)
        dialog --title "About Luckfox" --msgbox "$(femto-license.sh -l)" 0 0
      ;;
      7) #About Ubuntu)
        dialog --title "About Ubuntu" --msgbox "$(femto-license.sh -u)" 0 0
      ;;
      8)
        return
      ;;
    esac
  done
}

# Parse options
while getopts ":lw" opt; do
  case ${opt} in
    l) # Option -l (set lora radio)
      set_lora_radio
    ;;
    w) # Option -w (Wi-Fi config)
      wifi_config
    ;;
  esac
done
if [ -n "$1" ]; then
  exit
fi
# Main menu
while true; do
  choice=$(dialog --title "$(date)" --cancel-label "Exit" --menu "Femtofox Config" 15 40 5 \
    1 "Settings wizard" \
    2 "Networking" \
    3 "Meshtasticd" \
    4 "Misc" \
    5 "Software" \
    6 "Help" \
    "" "" \
    7 "Exit" 3>&1 1>&2 2>&3)
  
  exit_status=$? # This line checks the exit status of the dialog command
  
  if [ $exit_status -ne 0 ]; then # Exit the loop if the user selects "Cancel" or closes the dialog
    break
  fi
  
  case $choice in
    1) femto-install-wizard.sh ;;
    2) networking_settings ;;
    3) meshtasticd_settings ;;
    4) misc_settings ;;
    5) femto-software.sh ;;
    6) help_menu ;;
    7) break ;;
  esac
done